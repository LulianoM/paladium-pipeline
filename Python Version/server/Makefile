# Paladium Pipeline Server - Makefile
# MediaMTX Server para distribuiÃ§Ã£o SRT/HLS/WebRTC

.PHONY: help up down restart logs build rebuild clean status health test demo validate dev

# ConfiguraÃ§Ãµes
COMPOSE_FILE = docker-compose.yml
PROJECT_NAME = paladium-server
ENV_FILE = .env

# Cores para output
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
PURPLE = \033[0;35m
CYAN = \033[0;36m
WHITE = \033[1;37m
NC = \033[0m # No Color

# Default target
help: ## ğŸ“‹ Mostrar este menu de ajuda
	@echo ""
	@echo "$(CYAN)ğŸ¬ Paladium Pipeline Server - Comandos DisponÃ­veis$(NC)"
	@echo ""
	@echo "$(WHITE)Comandos Principais:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(WHITE)Exemplos de Uso:$(NC)"
	@echo "  $(YELLOW)make demo$(NC)          # Demo completa (recomendado)"
	@echo "  $(YELLOW)make up$(NC)            # Iniciar servidor"
	@echo "  $(YELLOW)make logs$(NC)          # Ver logs em tempo real"
	@echo "  $(YELLOW)make test-hls$(NC)      # Testar stream HLS"
	@echo ""

##@ ğŸš€ Comandos Principais

up: ## ğŸš€ Iniciar servidor MediaMTX e web app
	@echo "$(GREEN)ğŸš€ Iniciando Paladium Pipeline Server...$(NC)"
	@docker compose -f $(COMPOSE_FILE) up -d
	@echo "$(GREEN)âœ… Servidor iniciado!$(NC)"
	@echo ""
	@echo "$(CYAN)ğŸ“¡ Endpoints disponÃ­veis:$(NC)"
	@echo "  $(WHITE)Web App (HLS):$(NC)     http://localhost:8080"
	@echo "  $(WHITE)HLS Stream:$(NC)        http://localhost:8888/cam1/index.m3u8"
	@echo "  $(WHITE)WebRTC Player:$(NC)     http://localhost:8554/cam1"
	@echo "  $(WHITE)SRT Stream:$(NC)        srt://localhost:9000?mode=caller&streamid=#!::r=cam1,m=read"
	@echo "  $(WHITE)API MediaMTX:$(NC)      http://localhost:9997"
	@echo ""

down: ## ğŸ›‘ Parar todos os serviÃ§os
	@echo "$(RED)ğŸ›‘ Parando Paladium Pipeline Server...$(NC)"
	@docker compose -f $(COMPOSE_FILE) down
	@echo "$(RED)âœ… Servidor parado!$(NC)"

restart: down up ## ğŸ”„ Reiniciar servidor

demo: validate build up status ## ğŸ¯ Demo completa (recomendado)
	@echo ""
	@echo "$(CYAN)ğŸ¬ Demo do Paladium Pipeline Server$(NC)"
	@echo ""
	@echo "$(WHITE)1. Aguarde a Pipeline 2 publicar via SRT...$(NC)"
	@echo "$(WHITE)2. Abra o navegador: $(YELLOW)http://localhost:8080$(NC)"
	@echo "$(WHITE)3. Clique em 'Iniciar Stream' na interface web$(NC)"
	@echo "$(WHITE)4. Teste outros players:$(NC)"
	@echo "   $(CYAN)VLC:$(NC) vlc srt://localhost:9000?mode=caller&streamid=#!::r=cam1,m=read"
	@echo "   $(CYAN)WebRTC:$(NC) http://localhost:8554/cam1"
	@echo ""
	@echo "$(GREEN)âœ¨ Demo iniciada com sucesso!$(NC)"

##@ ğŸ“Š Monitoramento

logs: ## ğŸ“‹ Ver logs em tempo real
	@docker compose -f $(COMPOSE_FILE) logs -f

logs-mediamtx: ## ğŸ“‹ Ver logs apenas do MediaMTX
	@docker compose -f $(COMPOSE_FILE) logs -f mediamtx

logs-web: ## ğŸ“‹ Ver logs apenas do web app
	@docker compose -f $(COMPOSE_FILE) logs -f web

status: ## ğŸ“Š Status dos containers
	@echo "$(CYAN)ğŸ“Š Status dos Containers:$(NC)"
	@docker compose -f $(COMPOSE_FILE) ps
	@echo ""
	@echo "$(CYAN)ğŸ” VerificaÃ§Ã£o de SaÃºde:$(NC)"
	@docker compose -f $(COMPOSE_FILE) ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"

health: ## ğŸ¥ Verificar saÃºde dos serviÃ§os
	@echo "$(CYAN)ğŸ¥ VerificaÃ§Ã£o de SaÃºde dos ServiÃ§os:$(NC)"
	@echo ""
	@echo "$(WHITE)MediaMTX API:$(NC)"
	@curl -s -f http://localhost:9997/v3/config || echo "$(RED)âŒ MediaMTX API offline$(NC)"
	@echo ""
	@echo "$(WHITE)Web App:$(NC)"
	@curl -s -f -I http://localhost:8080 > /dev/null && echo "$(GREEN)âœ… Web App online$(NC)" || echo "$(RED)âŒ Web App offline$(NC)"
	@echo ""
	@echo "$(WHITE)HLS Endpoint:$(NC)"
	@curl -s -f -I http://localhost:8888/cam1/index.m3u8 > /dev/null && echo "$(GREEN)âœ… HLS endpoint online$(NC)" || echo "$(RED)âŒ HLS endpoint offline$(NC)"

monitor: ## ğŸ“ˆ Monitorar recursos dos containers
	@echo "$(CYAN)ğŸ“ˆ Monitoramento de Recursos:$(NC)"
	@docker stats --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}" --no-stream

##@ ğŸ”¨ Build e Desenvolvimento

build: ## ğŸ”¨ Build das imagens Docker
	@echo "$(BLUE)ğŸ”¨ Building Paladium Pipeline Server...$(NC)"
	@docker compose -f $(COMPOSE_FILE) build

rebuild: clean build ## ğŸ”„ Rebuild completo (limpa cache)
	@echo "$(BLUE)ğŸ”„ Rebuild completo finalizado!$(NC)"

dev: ## ğŸ› ï¸ Modo desenvolvimento (logs visÃ­veis)
	@echo "$(PURPLE)ğŸ› ï¸ Iniciando em modo desenvolvimento...$(NC)"
	@docker compose -f $(COMPOSE_FILE) up --build

dev-build: ## ğŸ› ï¸ Build sem cache para desenvolvimento
	@echo "$(PURPLE)ğŸ› ï¸ Build sem cache...$(NC)"
	@docker compose -f $(COMPOSE_FILE) build --no-cache

##@ ğŸ§ª Testes

test: test-endpoints test-hls test-srt ## ğŸ§ª Executar todos os testes

test-endpoints: ## ğŸŒ Testar endpoints HTTP
	@echo "$(CYAN)ğŸŒ Testando Endpoints HTTP...$(NC)"
	@echo "$(WHITE)Web App (8080):$(NC)"
	@curl -s -f -I http://localhost:8080 > /dev/null && echo "  $(GREEN)âœ… OK$(NC)" || echo "  $(RED)âŒ FAIL$(NC)"
	@echo "$(WHITE)MediaMTX API (9997):$(NC)"
	@curl -s -f http://localhost:9997/v3/config > /dev/null && echo "  $(GREEN)âœ… OK$(NC)" || echo "  $(RED)âŒ FAIL$(NC)"
	@echo "$(WHITE)HLS Server (8888):$(NC)"
	@curl -s -f -I http://localhost:8888 > /dev/null && echo "  $(GREEN)âœ… OK$(NC)" || echo "  $(RED)âŒ FAIL$(NC)"

test-hls: ## ğŸ“º Testar stream HLS com ffprobe
	@echo "$(CYAN)ğŸ“º Testando Stream HLS...$(NC)"
	@timeout 10 ffprobe -v quiet -show_format -show_streams http://localhost:8888/cam1/index.m3u8 2>/dev/null && \
		echo "$(GREEN)âœ… HLS stream disponÃ­vel$(NC)" || \
		echo "$(YELLOW)âš ï¸  HLS stream nÃ£o disponÃ­vel (normal se nÃ£o houver publish)$(NC)"

test-srt: ## ğŸ“¡ Testar disponibilidade SRT
	@echo "$(CYAN)ğŸ“¡ Testando Disponibilidade SRT...$(NC)"
	@nc -z -u localhost 9000 && \
		echo "$(GREEN)âœ… Porta SRT (9000) acessÃ­vel$(NC)" || \
		echo "$(RED)âŒ Porta SRT (9000) inacessÃ­vel$(NC)"

test-webrtc: ## ğŸŒ Testar WebRTC endpoint
	@echo "$(CYAN)ğŸŒ Testando WebRTC...$(NC)"
	@curl -s -f http://localhost:8554/cam1 > /dev/null && \
		echo "$(GREEN)âœ… WebRTC endpoint acessÃ­vel$(NC)" || \
		echo "$(RED)âŒ WebRTC endpoint inacessÃ­vel$(NC)"

##@ ğŸ§¹ Limpeza e ManutenÃ§Ã£o

clean: ## ğŸ§¹ Limpar containers e imagens
	@echo "$(RED)ğŸ§¹ Limpando containers e imagens...$(NC)"
	@docker compose -f $(COMPOSE_FILE) down --rmi all --volumes --remove-orphans
	@docker system prune -f
	@echo "$(RED)âœ… Limpeza concluÃ­da!$(NC)"

clean-logs: ## ğŸ“ Limpar logs dos containers
	@echo "$(YELLOW)ğŸ“ Limpando logs dos containers...$(NC)"
	@docker compose -f $(COMPOSE_FILE) logs --no-log-prefix > /dev/null 2>&1 || true
	@echo "$(YELLOW)âœ… Logs limpos!$(NC)"

clean-recordings: ## ğŸ¥ Limpar gravaÃ§Ãµes antigas
	@echo "$(YELLOW)ğŸ¥ Limpando gravaÃ§Ãµes antigas...$(NC)"
	@sudo rm -rf ./recordings/* 2>/dev/null || true
	@echo "$(YELLOW)âœ… GravaÃ§Ãµes limpas!$(NC)"

##@ ğŸ” ValidaÃ§Ã£o e InformaÃ§Ãµes

validate: ## âœ… Validar prÃ©-requisitos
	@echo "$(CYAN)âœ… Validando prÃ©-requisitos...$(NC)"
	@echo "$(WHITE)Docker:$(NC)"
	@docker --version > /dev/null && echo "  $(GREEN)âœ… Docker disponÃ­vel$(NC)" || (echo "  $(RED)âŒ Docker nÃ£o encontrado$(NC)" && exit 1)
	@echo "$(WHITE)Docker Compose:$(NC)"
	@docker compose version > /dev/null && echo "  $(GREEN)âœ… Docker Compose disponÃ­vel$(NC)" || (echo "  $(RED)âŒ Docker Compose nÃ£o encontrado$(NC)" && exit 1)
	@echo "$(WHITE)Portas necessÃ¡rias:$(NC)"
	@! nc -z localhost 8080 2>/dev/null && echo "  $(GREEN)âœ… Porta 8080 (Web) livre$(NC)" || echo "  $(YELLOW)âš ï¸  Porta 8080 em uso$(NC)"
	@! nc -z localhost 8888 2>/dev/null && echo "  $(GREEN)âœ… Porta 8888 (HLS) livre$(NC)" || echo "  $(YELLOW)âš ï¸  Porta 8888 em uso$(NC)"
	@! nc -z localhost 8554 2>/dev/null && echo "  $(GREEN)âœ… Porta 8554 (WebRTC) livre$(NC)" || echo "  $(YELLOW)âš ï¸  Porta 8554 em uso$(NC)"
	@! nc -z localhost 9000 2>/dev/null && echo "  $(GREEN)âœ… Porta 9000 (SRT) livre$(NC)" || echo "  $(YELLOW)âš ï¸  Porta 9000 em uso$(NC)"
	@echo "$(GREEN)âœ… ValidaÃ§Ã£o concluÃ­da!$(NC)"

info: ## â„¹ï¸  InformaÃ§Ãµes do projeto
	@echo "$(CYAN)â„¹ï¸  Paladium Pipeline Server$(NC)"
	@echo ""
	@echo "$(WHITE)VersÃ£o:$(NC) 1.0.0"
	@echo "$(WHITE)Tecnologias:$(NC) MediaMTX, Docker, HLS.js, Nginx"
	@echo "$(WHITE)Protocolos:$(NC) SRT (input), HLS, WebRTC, SRT (output)"
	@echo ""
	@echo "$(WHITE)Estrutura do Projeto:$(NC)"
	@echo "  ğŸ“ server/"
	@echo "  â”œâ”€â”€ ğŸ³ Dockerfile              # Imagem MediaMTX"
	@echo "  â”œâ”€â”€ ğŸ³ docker-compose.yml     # OrquestraÃ§Ã£o"
	@echo "  â”œâ”€â”€ âš™ï¸  mediamtx.yml           # ConfiguraÃ§Ã£o MediaMTX"
	@echo "  â”œâ”€â”€ ğŸ“ Makefile               # Este arquivo"
	@echo "  â”œâ”€â”€ ğŸ“„ env.example            # VariÃ¡veis de ambiente"
	@echo "  â”œâ”€â”€ ğŸ“– README.md              # DocumentaÃ§Ã£o"
	@echo "  â””â”€â”€ ğŸŒ web/                   # AplicaÃ§Ã£o web"
	@echo "      â”œâ”€â”€ ğŸ“„ index.html"
	@echo "      â”œâ”€â”€ ğŸ¨ style.css"
	@echo "      â””â”€â”€ ğŸ“œ app.js"
	@echo ""

urls: ## ğŸ”— Mostrar URLs de acesso
	@echo "$(CYAN)ğŸ”— URLs de Acesso:$(NC)"
	@echo ""
	@echo "$(WHITE)Interface Web (HLS Player):$(NC)"
	@echo "  $(BLUE)http://localhost:8080$(NC)"
	@echo ""
	@echo "$(WHITE)Streaming Endpoints:$(NC)"
	@echo "  $(GREEN)HLS:$(NC)     http://localhost:8888/cam1/index.m3u8"
	@echo "  $(GREEN)WebRTC:$(NC)  http://localhost:8554/cam1"
	@echo "  $(GREEN)SRT:$(NC)     srt://localhost:9000?mode=caller&streamid=#!::r=cam1,m=read"
	@echo ""
	@echo "$(WHITE)Comandos de Teste:$(NC)"
	@echo "  $(CYAN)VLC (SRT):$(NC)    vlc srt://localhost:9000?mode=caller&streamid=#!::r=cam1,m=read"
	@echo "  $(CYAN)FFplay (HLS):$(NC) ffplay http://localhost:8888/cam1/index.m3u8"
	@echo ""
	@echo "$(WHITE)APIs de Gerenciamento:$(NC)"
	@echo "  $(PURPLE)MediaMTX API:$(NC) http://localhost:9997"
	@echo "  $(PURPLE)MÃ©tricas:$(NC)     http://localhost:9998/metrics"
	@echo ""

##@ ğŸ”§ UtilitÃ¡rios

shell-mediamtx: ## ğŸš Shell no container MediaMTX
	@docker compose -f $(COMPOSE_FILE) exec mediamtx sh

shell-web: ## ğŸš Shell no container web
	@docker compose -f $(COMPOSE_FILE) exec web sh

backup-config: ## ğŸ’¾ Backup das configuraÃ§Ãµes
	@echo "$(BLUE)ğŸ’¾ Fazendo backup das configuraÃ§Ãµes...$(NC)"
	@mkdir -p backups
	@tar -czf backups/paladium-server-config-$(shell date +%Y%m%d_%H%M%S).tar.gz \
		mediamtx.yml docker-compose.yml Makefile env.example web/
	@echo "$(GREEN)âœ… Backup criado em backups/$(NC)"

network-info: ## ğŸŒ InformaÃ§Ãµes da rede Docker
	@echo "$(CYAN)ğŸŒ InformaÃ§Ãµes da Rede Docker:$(NC)"
	@docker network ls | grep paladium || echo "$(YELLOW)âš ï¸  Rede paladium nÃ£o encontrada$(NC)"
	@echo ""
	@docker compose -f $(COMPOSE_FILE) ps --format "table {{.Name}}\t{{.Ports}}"
